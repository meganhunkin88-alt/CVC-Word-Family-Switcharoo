<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>CVC Word Families</title>
<style>
  :root{
    --bg:#fffdf8;
    --ink:#222;
    --muted:#667085;
    --accent:#4f46e5;
    --btn:#f2f4ff;
    --green:#12a454;
    --red:#b42318;
    --tile:#ffffff;
    --shadow:0 6px 18px rgba(0,0,0,.08);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    color:var(--ink); background:var(--bg); -webkit-tap-highlight-color: transparent;
    display:flex; flex-direction:column;
  }
  header{
    padding:16px 20px; display:flex; align-items:center; gap:12px; justify-content:space-between;
    position:sticky; top:0; background:linear-gradient(180deg, rgba(255,253,248,0.95), rgba(255,253,248,0.6) 60%, transparent);
    backdrop-filter:saturate(180%) blur(8px);
    z-index:5;
  }
  .brand{font-weight:800; letter-spacing:.3px;}
  .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
  select, button{
    font-size:16px; border:0; padding:12px 14px; border-radius:14px; background:var(--btn); color:var(--ink);
    box-shadow:var(--shadow); cursor:pointer
  }
  select{appearance:none; padding-right:36px; background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%), linear-gradient(135deg, var(--muted) 50%, transparent 50%), linear-gradient(to right, #0000, #0000);
    background-position: calc(100% - 18px) 16px, calc(100% - 10px) 16px, 0 0;
    background-size: 8px 8px, 8px 8px, 100% 100%;
    background-repeat: no-repeat;
  }
  main{padding:18px; display:flex; flex-direction:column; gap:18px; max-width:1100px; width:100%; margin:0 auto}
  .stage{
    display:grid; grid-template-columns: 1fr auto 1fr; gap:16px; align-items:center; justify-items:center;
  }
  .tile{
    width:100%; max-width:180px; aspect-ratio:1/1; background:var(--tile); border-radius:var(--radius);
    display:flex; align-items:center; justify-content:center; box-shadow:var(--shadow);
    font-size:min(26vw, 150px); line-height:1; font-weight:900; user-select:none;
  }
  .tile.small{font-size:min(18vw, 110px)}
  .arrows{display:flex; gap:12px}
  .arrow{
    width:64px; height:64px; border-radius:20px; background:var(--btn); box-shadow:var(--shadow);
    display:grid; place-items:center; font-size:28px; font-weight:700;
  }
  .word{
    margin-top:8px; text-align:center; font-size:min(12vw, 80px); font-weight:900; letter-spacing:.02em;
  }
  .speak{
    display:inline-flex; align-items:center; gap:8px; padding:10px 14px; background:#ffffff; border-radius:999px; box-shadow:var(--shadow);
  }
  .bank{background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:14px}
  .bank h3{margin:4px 0 10px 0; font-size:16px; color:var(--muted); font-weight:700; letter-spacing:.02em; text-transform:uppercase}
  .chips{display:flex; flex-wrap:wrap; gap:10px}
  .chip{
    padding:10px 14px; background:var(--btn); border-radius:999px; font-weight:700; box-shadow:var(--shadow);
  }
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .pill{padding:10px 12px; border-radius:999px; background:#fff; box-shadow:var(--shadow); font-weight:700}
  footer{padding:18px; text-align:center; color:var(--muted); font-size:14px}
  .hint{color:var(--muted); font-weight:600; text-align:center}
  .mode{gap:6px}
  .canvasWrap{
    background:#fff; border-radius:16px; box-shadow:var(--shadow);
    padding:14px; display:flex; flex-direction:column; align-items:center; gap:8px;
  }
  .imgTitle{font-weight:800; color:var(--muted); font-size:14px; text-transform:uppercase; letter-spacing:.06em}
  .imgHolder{width:100%; max-width:620px; aspect-ratio: 4 / 3; background:#fafafa; border-radius:14px; display:grid; place-items:center; overflow:hidden}
  .imgHolder svg{width:100%; height:100%}
  .tag{display:inline-flex; align-items:center; gap:8px; font-weight:800}
  .ok{color:var(--green)}
  .no{color:var(--red)}
  .toolbar{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  .gallery{display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:12px}
  .card{background:#fff; border-radius:14px; box-shadow:var(--shadow); padding:10px; display:flex; flex-direction:column; gap:6px}
  .thumb{aspect-ratio:4/3; width:100%; background:#f4f4f5; border-radius:10px; display:grid; place-items:center; overflow:hidden}
  .thumb img{width:100%; height:100%; object-fit:cover}
  .card .cap{font-weight:800; text-align:center}
</style>
</head>
<body>
  <header>
    <div class="brand">CVC Builder</div>
    <div class="controls">
      <label class="pill">Family:
        <select id="family"></select>
      </label>
      <button id="shuffle">Shuffle</button>
      <label class="pill mode">Speak
        <input type="checkbox" id="speakToggle" checked>
      </label>
    </div>
  </header>
  <main>
    <div class="hint">Make real words to see a picture. Make silly (unreal) words to meet a cartoon monster named after your word!</div>

    <div class="stage" role="group" aria-label="letter tiles">
      <div class="arrows">
        <button class="arrow" id="prevOnset" aria-label="previous starting sound">â—€</button>
      </div>
      <div class="tile small" id="onset">b</div>
      <div class="arrows">
        <button class="arrow" id="nextOnset" aria-label="next starting sound">â–¶</button>
      </div>

      <div class="arrows">
        <button class="arrow" id="prevVowel" aria-label="previous vowel">â—€</button>
      </div>
      <div class="tile small" id="vowel">a</div>
      <div class="arrows">
        <button class="arrow" id="nextVowel" aria-label="next vowel">â–¶</button>
      </div>

      <div class="arrows">
        <button class="arrow" id="prevCoda" aria-label="previous ending sound">â—€</button>
      </div>
      <div class="tile small" id="coda">t</div>
      <div class="arrows">
        <button class="arrow" id="nextCoda" aria-label="next ending sound">â–¶</button>
      </div>
    </div>

    <div class="word" id="word">bat</div>
    <div style="text-align:center; display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap">
      <span id="status" class="tag ok">âœ… Real word</span>
      <button class="speak" id="speakBtn" aria-label="play word sound">ðŸ”Š Say it</button>
      <div class="toolbar">
        <button id="saveBtn">Save to gallery</button>
        <button id="dlBtn">Download PNG</button>
      </div>
    </div>

    <div class="canvasWrap" aria-live="polite">
      <div class="imgTitle">Picture</div>
      <div class="imgHolder" id="picture" role="img" aria-label="Illustration area"></div>
    </div>

    <div class="bank">
      <h3>Word Bank</h3>
      <div class="chips" id="bank"></div>
    </div>

    <div class="bank">
      <h3>Favourites Gallery</h3>
      <div class="gallery" id="gallery"></div>
    </div>

    <div class="row">
      <button id="newGoal">New goal</button>
      <span id="goal" class="pill"></span>
    </div>
  </main>
  <footer>
    Offline-friendly. Add to Home Screen for full-screen play.
  </footer>

<script>
// ------------ DATA -----------------
const FAMILIES = {
  "at": ["b","c","f","h","m","p","r","s","v"],
  "an": ["b","c","f","m","p","r","t","v"],
  "ap": ["c","g","m","n","s","t","w"],
  "ag": ["b","b","f","n","r","t","w"],
  "ad": ["b","d","f","h","l","m","p","s"],
  "am": ["h","j","l","r","s","t"],
  "et": ["g","g","j","l","m","n","p","s","v","w"],
  "en": ["b","c","d","h","h","k","m","p","t","w"],
  "ed": ["b","f","r","w"],
  "eg": ["b","k","l","l","m","p"],
  "in": ["b","f","f","p","p","t","w","w","p"],
  "it": ["b","f","h","k","k","p","s","s","w"],
  "ig": ["b","d","f","p","w"],
  "ip": ["d","f","h","k","l","n","s","t","z"],
  "im": ["h","j","l","p","r","s","t"],
  "id": ["b","d","f","g","h","k","l","l","r"],
  "ot": ["b","d","g","g","h","l","n","p","s"],
  "op": ["b","c","h","m","p","s","t"],
  "og": ["b","d","f","h","j","l"],
  "ob": ["j","j","k","l","m","n","r","s"],
  "od": ["c","g","n","p","r"],
  "ug": ["b","d","h","j","m","p","r","s","t"],
  "un": ["b","f","g","h","j","r","s"],
  "ut": ["b","c","c","g","h","j","n","p","r"],
  "um": ["b","g","g","h","n","s","s"]
};

const FAMILY_VOWEL = {
  "at":"a","an":"a","ap":"a","ag":"a","ad":"a","am":"a",
  "et":"e","en":"e","ed":"e","eg":"e",
  "in":"i","it":"i","ig":"i","ip":"i","im":"i","id":"i",
  "ot":"o","op":"o","og":"o","ob":"o","od":"o",
  "ug":"u","un":"u","ut":"u","um":"u"
};

const FAMILY_CODA = {
  "at":["t"], "an":["n"], "ap":["p"], "ag":["g"], "ad":["d"], "am":["m"],
  "et":["t"], "en":["n"], "ed":["d"], "eg":["g"],
  "in":["n"], "it":["t"], "ig":["g"], "ip":["p"], "im":["m"], "id":["d"],
  "ot":["t"], "op":["p"], "og":["g"], "ob":["b"], "od":["d"],
  "ug":["g"], "un":["n"], "ut":["t"], "um":["m"]
};

function buildWordList(){
  const map = {};
  for(const fam in FAMILIES){
    const vowel = FAMILY_VOWEL[fam];
    const codas = FAMILY_CODA[fam];
    map[fam] = [];
    for(const onset of FAMILIES[fam]){
      for(const c of codas){
        map[fam].push((onset+vowel+c).toLowerCase());
      }
    }
    map[fam] = Array.from(new Set(map[fam]));
  }
  const remove = ["vam","vat","von","vum","vug","vop","vog","vut"]; // prune uncommon
  for(const fam in map) map[fam] = map[fam].filter(w=>!remove.includes(w));
  // Ensure a few classics exist even if not in onset list
  if(!map["at"].includes("cat")) map["at"].push("cat");
  if(!map["og"].includes("dog")) map["og"].push("dog");
  return map;
}
const WORDS = buildWordList();

// ------------ PICTURES -------------
const PICS = {
  // a-family
  cat:()=>svgCat(),
  bat:()=>svgBat(),
  rat:()=>svgRat(),
  hat:()=>svgHat(),
  mat:()=>svgMat(),
  man:()=>svgPerson("Man"),
  fan:()=>svgFan(),
  pan:()=>svgPan(),
  cap:()=>svgCap(),
  map:()=>svgMap(),
  bag:()=>svgBag(),
  bad:()=>svgFace("bad"),
  jam:()=>svgJam(),
  van:()=>svgVan(),
  // e-family
  bed:()=>svgBed(),
  red:()=>svgColorBox("#e51d2a","red"),
  leg:()=>svgLeg(),
  pen:()=>svgPen(),
  hen:()=>svgHen(),
  ten:()=>svgTen(),
  jet:()=>svgJet(),
  // i-family
  pig:()=>svgPig(),
  pin:()=>svgPin(),
  fin:()=>svgFin(),
  lid:()=>svgLid(),
  kid:()=>svgPerson("Kid"),
  wig:()=>svgWig(),
  // o-family
  log:()=>svgLog(),
  dog:()=>svgDog(),
  pot:()=>svgPot(),
  top:()=>svgTop(),
  // u-family
  sun:()=>svgSun(),
  bun:()=>svgBun(),
  mug:()=>svgMug(),
  bug:()=>svgBug()
};

function svgFallback(label){
  return `
  <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${label} picture">
    <rect x="0" y="0" width="400" height="300" fill="#f3f4f6"/>
    <rect x="60" y="40" width="280" height="200" rx="18" fill="#dbeafe" stroke="#93c5fd" stroke-width="6"/>
    <path d="M80 200 L160 140 L220 180 L300 120 L340 200 Z" fill="#93c5fd"/>
    <circle cx="130" cy="110" r="30" fill="#fde68a" stroke="#f59e0b" stroke-width="6"/>
    <text x="200" y="260" text-anchor="middle" font-weight="800" font-size="28" fill="#374151">${label}</text>
  </svg>`;
}

// --- SVG doodles --- (existing + new)
function svgSun(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#e0f2fe"/><circle cx="200" cy="150" r="60" fill="#fde047" stroke="#f59e0b" stroke-width="10"/>
${Array.from({length:12},(_,i)=>{
  const a=i*30*Math.PI/180; const x1=200+Math.cos(a)*85; const y1=150+Math.sin(a)*85; const x2=200+Math.cos(a)*115; const y2=150+Math.sin(a)*115;
  return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#f59e0b" stroke-width="8"/>`}).join("")}
</svg>`}
function svgDog(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fff7ed"/>
<ellipse cx="220" cy="170" rx="120" ry="60" fill="#c4b5fd"/><circle cx="130" cy="150" r="45" fill="#a78bfa"/><circle cx="270" cy="150" r="45" fill="#a78bfa"/>
<circle cx="250" cy="140" r="8" fill="#111"/><circle cx="290" cy="140" r="8" fill="#111"/>
<circle cx="270" cy="160" r="10" fill="#ef4444"/>
<path d="M100 140 q-30 -30 -40 10" stroke="#a78bfa" stroke-width="14" fill="none" stroke-linecap="round"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#6b7280">dog</text>
</svg>`}
function svgCat(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fef3c7"/>
<circle cx="200" cy="150" r="70" fill="#93c5fd"/><polygon points="150,100 175,60 190,110" fill="#93c5fd"/><polygon points="250,100 225,60 210,110" fill="#93c5fd"/>
<circle cx="180" cy="140" r="8"/><circle cx="220" cy="140" r="8"/><path d="M190 165 q10 10 20 0" stroke="#000" stroke-width="6" fill="none" stroke-linecap="round"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#6b7280">cat</text>
</svg>`}
function svgBat(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#0f172a"/><circle cx="200" cy="80" r="30" fill="#fde68a"/>
<path d="M70 180 Q140 120 200 180 Q260 120 330 180 Q260 120 200 140 Q140 120 70 180 Z" fill="#94a3b8"/>
<circle cx="200" cy="150" r="12" fill="#fff"/><circle cx="220" cy="150" r="12" fill="#fff"/><circle cx="200" cy="150" r="6"/><circle cx="220" cy="150" r="6"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#e5e7eb">bat</text>
</svg>`}
function svgRat(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#ecfeff"/><ellipse cx="200" cy="170" rx="90" ry="55" fill="#94a3b8"/><circle cx="250" cy="140" r="18" fill="#94a3b8"/>
<circle cx="260" cy="135" r="6"/><line x1="260" y1="160" x2="320" y2="150" stroke="#94a3b8" stroke-width="6"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#475569">rat</text></svg>`}
function svgHat(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#e0f7fa"/><rect x="90" y="140" width="220" height="60" rx="10" fill="#1e293b"/><rect x="150" y="100" width="100" height="60" rx="8" fill="#334155"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#334155">hat</text></svg>`}
function svgMat(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fffbeb"/><rect x="90" y="90" width="220" height="120" rx="14" fill="#86efac" stroke="#16a34a" stroke-width="6"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#166534">mat</text></svg>`}
function svgPerson(lbl){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fef2f2"/><circle cx="200" cy="120" r="40" fill="#fde68a"/><rect x="150" y="160" width="100" height="80" rx="18" fill="#93c5fd"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#334155">${lbl.toLowerCase()}</text></svg>`}
function svgFan(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#eef2ff"/><circle cx="200" cy="150" r="18" fill="#1d4ed8"/>
${[0,90,180,270].map(a=>`<path d="M200 150 L200 80 A70 70 0 0 1 270 150 Z" fill="#93c5fd" transform="rotate(${a},200,150)"/>`).join("")}
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#1d4ed8">fan</text></svg>`}
function svgPan(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#f1f5f9"/><rect x="90" y="150" width="180" height="40" rx="8" fill="#94a3b8"/><rect x="270" y="160" width="60" height="18" rx="9" fill="#64748b"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#475569">pan</text></svg>`}
function svgCap(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#ecfeff"/><path d="M100 180 q100 -120 200 0 Z" fill="#38bdf8"/><rect x="260" y="180" width="80" height="20" rx="10" fill="#0ea5e9"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#0284c7">cap</text></svg>`}
function svgMap(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fff7ed"/><polygon points="80,80 150,60 220,90 300,70 320,100 320,220 250,240 180,210 100,230 80,200" fill="#fde68a" stroke="#f59e0b" stroke-width="6"/>
<path d="M100 110 Q160 160 230 120 T310 160" stroke="#22c55e" stroke-width="6" fill="none"/>
<circle cx="230" cy="120" r="10" fill="#ef4444"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#92400e">map</text></svg>`}
function svgBag(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#faf5ff"/><rect x="130" y="110" width="140" height="120" rx="18" fill="#a78bfa"/><path d="M150 110 q50 -40 100 0" stroke="#7c3aed" stroke-width="10" fill="none"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#6b21a8">bag</text></svg>`}
function svgFace(kind){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fee2e2"/><circle cx="200" cy="150" r="70" fill="#fecaca"/><circle cx="180" cy="140" r="8"/><circle cx="220" cy="140" r="8"/>
<path d="M160 180 q40 -20 80 0" stroke="#991b1b" stroke-width="8" fill="none" stroke-linecap="round"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#b91c1c">${kind}</text></svg>`}
function svgJam(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fff1f2"/><rect x="150" y="90" width="100" height="140" rx="18" fill="#fb7185" stroke="#be123c" stroke-width="8"/>
<rect x="150" y="70" width="100" height="30" rx="8" fill="#fda4af"/><text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#be123c">jam</text></svg>`}
function svgBed(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#eff6ff"/><rect x="80" y="150" width="260" height="70" rx="10" fill="#93c5fd"/><rect x="80" y="130" width="120" height="30" rx="6" fill="#bfdbfe"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#1e3a8a">bed</text></svg>`}
function svgColorBox(c,label){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="${c}"/><text x="200" y="160" text-anchor="middle" font-size="72" font-weight="900" fill="#fff">${label}</text></svg>`}
function svgLeg(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#ecfeff"/><rect x="180" y="90" width="40" height="130" rx="10" fill="#fbbf24"/><rect x="170" y="220" width="60" height="16" rx="8" fill="#78350f"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#0ea5e9">leg</text></svg>`}
function svgPen(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#f0fdf4"/><rect x="120" y="130" width="180" height="18" rx="9" fill="#10b981"/><polygon points="300,130 340,139 300,148" fill="#065f46"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#047857">pen</text></svg>`}
function svgHen(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fef9c3"/><circle cx="200" cy="150" r="50" fill="#fde68a"/><circle cx="180" cy="140" r="6"/><circle cx="220" cy="140" r="6"/><polygon points="230,155 260,150 230,145" fill="#ea580c"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#92400e">hen</text></svg>`}
function svgPig(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fff1f2"/><circle cx="200" cy="150" r="60" fill="#f9a8d4"/><rect x="170" y="160" width="60" height="30" rx="10" fill="#f472b6"/><circle cx="190" cy="175" r="6"/><circle cx="210" cy="175" r="6"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#be185d">pig</text></svg>`}
function svgPin(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#eef2ff"/><circle cx="200" cy="110" r="26" fill="#6366f1"/><rect x="194" y="136" width="12" height="90" rx="6" fill="#6366f1"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#3730a3">pin</text></svg>`}
function svgFin(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#cffafe"/><path d="M120 200 Q200 80 280 200 Z" fill="#06b6d4"/><rect x="120" y="200" width="160" height="16" fill="#0891b2"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#0e7490">fin</text></svg>`}
function svgLid(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#f1f5f9"/><rect x="140" y="180" width="120" height="40" rx="10" fill="#94a3b8"/><rect x="130" y="160" width="140" height="20" rx="10" fill="#cbd5e1"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#475569">lid</text></svg>`}
function svgLog(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#dcfce7"/><rect x="100" y="160" width="200" height="40" rx="20" fill="#a16207"/><circle cx="120" cy="180" r="12" fill="#fbbf24"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#166534">log</text></svg>`}
function svgPot(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fef9c3"/><rect x="120" y="150" width="160" height="60" rx="10" fill="#f97316"/><rect x="110" y="140" width="180" height="16" rx="8" fill="#fb923c"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#c2410c">pot</text></svg>`}
function svgTop(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#f0f9ff"/><circle cx="200" cy="170" r="40" fill="#38bdf8"/><rect x="195" y="90" width="10" height="40" rx="5" fill="#0ea5e9"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#0369a1">top</text></svg>`}
function svgMug(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fafaf9"/><rect x="130" y="120" width="140" height="110" rx="16" fill="#60a5fa"/><circle cx="280" cy="160" r="24" fill="#93c5fd"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#1d4ed8">mug</text></svg>`}
function svgBug(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#ecfeff"/><circle cx="200" cy="160" r="50" fill="#34d399"/><line x1="140" y1="160" x2="260" y2="160" stroke="#065f46" stroke-width="8"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#047857">bug</text></svg>`}
function svgBun(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#fff7ed"/><ellipse cx="200" cy="170" rx="110" ry="50" fill="#fde68a" stroke="#f59e0b" stroke-width="8"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#b45309">bun</text></svg>`}
function svgVan(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#eff6ff"/><rect x="80" y="150" width="240" height="70" rx="14" fill="#60a5fa"/><rect x="100" y="130" width="120" height="40" rx="8" fill="#93c5fd"/>
<circle cx="140" cy="230" r="16" fill="#334155"/><circle cx="260" cy="230" r="16" fill="#334155"/>
<text x="200" y="270" text-anchor="middle" font-size="28" font-weight="800" fill="#1d4ed8">van</text></svg>`}
function svgTen(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#ecfeff"/><text x="200" y="160" text-anchor="middle" font-size="120" font-weight="900" fill="#06b6d4">10</text>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#0e7490">ten</text></svg>`}
function svgJet(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#f0f9ff"/><polygon points="140,160 300,140 170,120" fill="#93c5fd"/><rect x="100" y="150" width="60" height="12" rx="6" fill="#0ea5e9"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#0284c7">jet</text></svg>`}
function svgWig(){return `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
<rect width="400" height="300" fill="#f5f3ff"/><ellipse cx="200" cy="170" rx="100" ry="50" fill="#a78bfa"/><path d="M100 170 q100 -80 200 0" stroke="#7c3aed" stroke-width="10" fill="none"/>
<text x="200" y="260" text-anchor="middle" font-size="28" font-weight="800" fill="#6d28d9">wig</text></svg>`}

// ------------- MONSTER GENERATOR ---------------
function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0;} return Math.abs(h); }
function colorFrom(seed){ const hue = seed % 360; return `hsl(${hue},80%,60%)`; }
function monsterSVG(name){
  const seed = hashCode(name);
  const body = colorFrom(seed);
  const belly = `hsl(${(seed+180)%360},80%,88%)`;
  const eyeCount = 1 + (seed % 3);
  const horns = (seed % 2)===0;
  const teeth = (seed % 5)===0;
  const arms = (seed % 3)+1;

  let eyes=""; for(let i=0;i<eyeCount;i++){ const x = 200 + (i-(eyeCount-1)/2)*30;
    eyes += `<circle cx="${x}" cy="130" r="14" fill="#fff"/><circle cx="${x}" cy="130" r="6" fill="#111"/>`; }
  let armStr=""; for(let i=0;i<arms;i++){
    const ax = 120 + i*40; armStr += `<line x1="${ax}" y1="220" x2="${ax-30}" y2="200" stroke="${body}" stroke-width="14" stroke-linecap="round"/>`;
  }
  let armStr2=""; for(let i=0;i<arms;i++){
    const ax = 280 - i*40; armStr2 += `<line x1="${ax}" y1="220" x2="${ax+30}" y2="200" stroke="${body}" stroke-width="14" stroke-linecap="round"/>`;
  }

  return `
  <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Monster named ${name}">
    <rect width="400" height="300" fill="#f8fafc"/>
    <ellipse cx="200" cy="180" rx="120" ry="80" fill="${body}"/>
    <ellipse cx="200" cy="190" rx="70" ry="40" fill="${belly}"/>
    ${horns?`<polygon points="160,90 180,120 140,120" fill="${body}"/><polygon points="240,90 260,120 220,120" fill="${body}"/>`:``}
    ${eyes}
    <rect x="160" y="180" width="80" height="20" rx="10" fill="#111"/>
    ${teeth?`<g fill="#fff">${[0,1,2,3,4].map(i=>`<polygon points="${170+i*16},180 ${176+i*16},180 ${173+i*16},188"/>`).join("")}</g>`:""}
    ${armStr}${armStr2}
    <text x="200" y="280" text-anchor="middle" font-size="28" font-weight="900" fill="#334155">${name}</text>
  </svg>`;
}

// ------------ STATE/DOM -----------------
const familySel = document.getElementById("family");
const onsetTile = document.getElementById("onset");
const vowelTile = document.getElementById("vowel");
const codaTile = document.getElementById("coda");
const wordEl = document.getElementById("word");
const bankEl = document.getElementById("bank");
const goalEl = document.getElementById("goal");
const speakBtn = document.getElementById("speakBtn");
const speakToggle = document.getElementById("speakToggle");
const picture = document.getElementById("picture");
const statusEl = document.getElementById("status");
const gallery = document.getElementById("gallery");
const saveBtn = document.getElementById("saveBtn");
const dlBtn = document.getElementById("dlBtn");

let state = { family: "at", onsetIndex: 0, codaIndex: 0 };
let currentSVG = ""; // store latest svg string

function populateFamilies(){
  const keys = Object.keys(FAMILIES);
  for(const k of keys){
    const opt = document.createElement("option");
    opt.value = k; opt.textContent = "-" + k;
    familySel.appendChild(opt);
  }
}
populateFamilies();

function speak(text){
  if(!speakToggle.checked) return;
  try{ const u = new SpeechSynthesisUtterance(text); u.lang="en-AU"; u.rate=0.9; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){}
}

function setFamily(fam){
  state.family = fam;
  const onsets = FAMILIES[fam];
  const codas = FAMILY_CODA[fam];
  state.onsetIndex = Math.floor(Math.random()*onsets.length);
  state.codaIndex = 0;
  vowelTile.textContent = FAMILY_VOWEL[fam];
  onsetTile.textContent = onsets[state.onsetIndex];
  codaTile.textContent = codas[state.codaIndex];
  updateWord();
  renderBank();
  newGoal();
}

function isReal(w){ return WORDS[state.family].includes(w); }

function drawIllustration(word, real){
  if(real){
    const key = word.toLowerCase();
    const svg = (PICS[key] ? PICS[key]() : svgFallback(key));
    picture.innerHTML = svg;
    picture.setAttribute("aria-label", `Picture of ${key}`);
    currentSVG = svg;
  }else{
    const svg = monsterSVG(word);
    picture.innerHTML = svg;
    picture.setAttribute("aria-label", `Monster named ${word}`);
    currentSVG = svg;
  }
}

function updateWord(){
  const w = (onsetTile.textContent + vowelTile.textContent + codaTile.textContent).toLowerCase();
  wordEl.textContent = w;
  const real = isReal(w);
  statusEl.className = "tag " + (real ? "ok" : "no");
  statusEl.textContent = real ? "âœ… Real word" : "ðŸ‘¾ Monster (not a real word)";
  wordEl.style.color = real ? "var(--ink)" : "var(--red)";
  speak(w);
  drawIllustration(w, real);
}

function renderBank(){
  bankEl.innerHTML = "";
  for(const w of WORDS[state.family]){
    const btn = document.createElement("button");
    btn.className = "chip"; btn.textContent = w;
    btn.addEventListener("click", ()=>{
      onsetTile.textContent = w[0]; vowelTile.textContent = w[1]; codaTile.textContent = w[2];
      updateWord();
    });
    bankEl.appendChild(btn);
  }
}

function cycleOnset(dir){
  const arr = FAMILIES[state.family];
  state.onsetIndex = (state.onsetIndex + dir + arr.length) % arr.length;
  onsetTile.textContent = arr[state.onsetIndex];
  updateWord();
}
function cycleVowel(dir){
  const vowels = ["a","e","i","o","u"];
  let i = vowels.indexOf(vowelTile.textContent);
  i = (i + dir + vowels.length) % vowels.length;
  vowelTile.textContent = vowels[i];
  updateWord();
}
function cycleCoda(dir){
  const arr = FAMILY_CODA[state.family];
  state.codaIndex = (state.codaIndex + dir + arr.length) % arr.length;
  codaTile.textContent = arr[state.codaIndex];
  updateWord();
}

document.getElementById("prevOnset").onclick = ()=>cycleOnset(-1);
document.getElementById("nextOnset").onclick = ()=>cycleOnset(1);
document.getElementById("prevVowel").onclick = ()=>cycleVowel(-1);
document.getElementById("nextVowel").onclick = ()=>cycleVowel(1);
document.getElementById("prevCoda").onclick = ()=>cycleCoda(-1);
document.getElementById("nextCoda").onclick = ()=>cycleCoda(1);
familySel.addEventListener("change", e=> setFamily(e.target.value));
document.getElementById("shuffle").addEventListener("click", ()=> setFamily(state.family));
speakBtn.addEventListener("click", ()=> speak(wordEl.textContent));

function newGoal(){
  const words = WORDS[state.family];
  goalEl.textContent = "Goal: " + words[Math.floor(Math.random()*words.length)];
}
document.getElementById("newGoal").addEventListener("click", newGoal);

// ------------ GALLERY (localStorage) -------------
function toPNG(svgText, name){
  return new Promise((resolve)=>{
    const svgBlob = new Blob([svgText], {type: 'image/svg+xml'});
    const url = URL.createObjectURL(svgBlob);
    const img = new Image();
    img.onload = ()=>{
      const canvas = document.createElement('canvas');
      canvas.width = 1200; canvas.height = 900; // 4:3
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      URL.revokeObjectURL(url);
      resolve(canvas.toDataURL('image/png'));
    };
    img.src = url;
  });
}

function loadGallery(){
  const items = JSON.parse(localStorage.getItem('cvc_gallery')||'[]');
  gallery.innerHTML = "";
  for(const it of items){
    const card = document.createElement('div'); card.className='card';
    const th = document.createElement('div'); th.className='thumb';
    const img = document.createElement('img'); img.src = it.png || `data:image/svg+xml;utf8,${encodeURIComponent(it.svg)}`;
    th.appendChild(img);
    const cap = document.createElement('div'); cap.className='cap'; cap.textContent = it.name;
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.justifyContent='center';
    const del = document.createElement('button'); del.textContent='Delete';
    del.onclick = ()=>{
      const arr = JSON.parse(localStorage.getItem('cvc_gallery')||'[]').filter(x=>x.id!==it.id);
      localStorage.setItem('cvc_gallery', JSON.stringify(arr)); loadGallery();
    };
    const dl = document.createElement('button'); dl.textContent='Download PNG';
    dl.onclick = ()=>{
      const a = document.createElement('a');
      a.href = it.png || `data:image/svg+xml;utf8,${encodeURIComponent(it.svg)}`;
      a.download = it.name + (it.png?'.png':'.svg');
      a.click();
    };
    row.appendChild(del); row.appendChild(dl);
    card.appendChild(th); card.appendChild(cap); card.appendChild(row);
    gallery.appendChild(card);
  }
}

saveBtn.addEventListener('click', async ()=>{
  const name = wordEl.textContent.toLowerCase();
  const png = await toPNG(currentSVG, name);
  const item = { id: Date.now(), name, svg: currentSVG, png };
  const items = JSON.parse(localStorage.getItem('cvc_gallery')||'[]'); items.unshift(item);
  localStorage.setItem('cvc_gallery', JSON.stringify(items));
  loadGallery();
});

dlBtn.addEventListener('click', async ()=>{
  const name = wordEl.textContent.toLowerCase();
  const png = await toPNG(currentSVG, name);
  const a = document.createElement('a'); a.href = png; a.download = name + '.png'; a.click();
});

// Boot
setFamily("at");
familySel.value = "at";
loadGallery();
</script>
</body>
</html>
